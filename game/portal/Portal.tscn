[gd_scene load_steps=12 format=2]

[ext_resource path="res://particles/portal/PortalParticles.tscn" type="PackedScene" id=1]
[ext_resource path="res://portal/Portal.gd" type="Script" id=2]

[sub_resource type="GDScript" id=1]
script/source = "extends Area2D

# Returns all overlapping bodies within the area
# as an array of polygons positioned in world space.
func calculate_polygon():
    var polygons = []
    
    for overlapped_body in get_overlapping_bodies():
        if !(overlapped_body is StaticBody2D): continue
        if overlapped_body.name == \"PortalLine\": continue
        var overlapped_body_rid = overlapped_body.get_rid()
        var overlapped_body_shapes_count = Physics2DServer.body_get_shape_count (overlapped_body_rid)
        var overlapped_body_tf = overlapped_body.global_transform
        
        for i in range(overlapped_body_shapes_count):
            var shapeRID = Physics2DServer.body_get_shape(overlapped_body_rid, i)
            var shape_tf = Physics2DServer.body_get_shape_transform(overlapped_body_rid, i)
            var polygon = PolygonUtils.shape_to_polygon(shapeRID)
            if (polygon == null): continue
            polygon = PolygonUtils.transform_polygon(polygon, shape_tf * overlapped_body_tf)
            polygons.append(polygon)
    

    var csRID = get_node(\"CollisionShape2D\").shape.get_rid()
    var outerAreaShape = PolygonUtils.shape_to_polygon(csRID)
    
    outerAreaShape = PolygonUtils.transform_polygon(outerAreaShape, get_node(\"CollisionShape2D\").global_transform)
    
    var new_polygons = []
    
    for polygon in polygons:
        for new_polygon in Geometry.intersect_polygons_2d(polygon, outerAreaShape):
            new_polygons.append(new_polygon)
    
    return new_polygons
"

[sub_resource type="RectangleShape2D" id=2]
extents = Vector2( 48, 128 )

[sub_resource type="RectangleShape2D" id=3]
extents = Vector2( 112, 304 )

[sub_resource type="RectangleShape2D" id=4]
extents = Vector2( 16, 304 )

[sub_resource type="SegmentShape2D" id=5]
a = Vector2( 0, -128 )
b = Vector2( 0, 128 )

[sub_resource type="Animation" id=7]
resource_name = "BindPose"
length = 0.1
tracks/0/type = "bezier"
tracks/0/path = NodePath("ColorNode/ColorRect:rect_size:y")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"points": PoolRealArray( 256, -0.599909, -0.701569, 0.25, 0 ),
"times": PoolRealArray( 0 )
}
tracks/1/type = "bezier"
tracks/1/path = NodePath("ColorNode/ColorRect:rect_position:y")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/keys = {
"points": PoolRealArray( -128, -0.602215, -1.90172, 0.25, 0 ),
"times": PoolRealArray( 0 )
}
tracks/2/type = "bezier"
tracks/2/path = NodePath("ColorNode/ColorRect:rect_size:x")
tracks/2/interp = 1
tracks/2/loop_wrap = true
tracks/2/imported = false
tracks/2/enabled = true
tracks/2/keys = {
"points": PoolRealArray( 4, -0.25, 0, 0.25, 0 ),
"times": PoolRealArray( 0 )
}

[sub_resource type="Animation" id=9]
resource_name = "close_portal"
length = 0.5
tracks/0/type = "bezier"
tracks/0/path = NodePath("ColorNode/ColorRect:rect_size:y")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"points": PoolRealArray( 256, -0.599909, -0.701569, 0.25, 0 ),
"times": PoolRealArray( 0 )
}
tracks/1/type = "bezier"
tracks/1/path = NodePath("ColorNode/ColorRect:rect_position:y")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/keys = {
"points": PoolRealArray( -128, -0.602215, -1.90172, 0.25, 0 ),
"times": PoolRealArray( 0 )
}
tracks/2/type = "bezier"
tracks/2/path = NodePath("ColorNode/ColorRect:rect_size:x")
tracks/2/interp = 1
tracks/2/loop_wrap = true
tracks/2/imported = false
tracks/2/enabled = true
tracks/2/keys = {
"points": PoolRealArray( 4, -0.25, 0, 0.25, 0, 0, -0.25, 0, 0.25, 0 ),
"times": PoolRealArray( 0, 0.5 )
}

[sub_resource type="Animation" id=10]
resource_name = "closed_portal"
length = 0.1
tracks/0/type = "bezier"
tracks/0/path = NodePath("ColorNode/ColorRect:rect_size:y")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"points": PoolRealArray(  ),
"times": PoolRealArray(  )
}
tracks/1/type = "bezier"
tracks/1/path = NodePath("ColorNode/ColorRect:rect_position:y")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/keys = {
"points": PoolRealArray(  ),
"times": PoolRealArray(  )
}
tracks/2/type = "bezier"
tracks/2/path = NodePath("ColorNode/ColorRect:rect_size:x")
tracks/2/interp = 1
tracks/2/loop_wrap = true
tracks/2/imported = false
tracks/2/enabled = true
tracks/2/keys = {
"points": PoolRealArray( 0, -0.25, 0, 0.25, 0 ),
"times": PoolRealArray( 0 )
}

[sub_resource type="Animation" id=8]
resource_name = "open_portal"
length = 0.5
tracks/0/type = "bezier"
tracks/0/path = NodePath("ColorNode/ColorRect:rect_size:y")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"points": PoolRealArray( 0, -0.25, 0, 0.25, 0, 256, -0.599909, -0.701569, 0.25, 0 ),
"times": PoolRealArray( 0, 0.5 )
}
tracks/1/type = "bezier"
tracks/1/path = NodePath("ColorNode/ColorRect:rect_position:y")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/keys = {
"points": PoolRealArray( 0, -0.25, 0, 0.25, 0, -128, -0.602215, -1.90172, 0.25, 0 ),
"times": PoolRealArray( 0, 0.5 )
}
tracks/2/type = "bezier"
tracks/2/path = NodePath("ColorNode/ColorRect:rect_size:x")
tracks/2/interp = 1
tracks/2/loop_wrap = true
tracks/2/imported = false
tracks/2/enabled = true
tracks/2/keys = {
"points": PoolRealArray( 4, -0.25, 0, 0.25, 0, 4, -0.25, 0, 0.25, 0 ),
"times": PoolRealArray( 0, 0.5 )
}

[node name="Portal" type="Node2D"]
script = ExtResource( 2 )

[node name="InnerArea" type="Area2D" parent="."]
visible = false
position = Vector2( -32, 0 )
monitorable = false
collision_layer = 0
collision_mask = 12
script = SubResource( 1 )

[node name="InnerAreaCollisionShape2D" type="CollisionShape2D" parent="InnerArea"]
position = Vector2( 64, 0 )
shape = SubResource( 2 )

[node name="OuterArea" type="Area2D" parent="."]
visible = false
monitorable = false
collision_layer = 0
collision_mask = 50

[node name="CollisionShape2D" type="CollisionShape2D" parent="OuterArea"]
position = Vector2( 111, 0 )
shape = SubResource( 3 )

[node name="ScanAreaFront" type="Area2D" parent="."]
visible = false
collision_layer = 0
collision_mask = 2

[node name="CollisionShape2D" type="CollisionShape2D" parent="ScanAreaFront"]
position = Vector2( 112, 0 )
shape = SubResource( 3 )

[node name="ScanAreaBack" type="Area2D" parent="."]
visible = false
collision_layer = 0
collision_mask = 2

[node name="CollisionShape2D" type="CollisionShape2D" parent="ScanAreaBack"]
position = Vector2( -16, 0 )
shape = SubResource( 4 )

[node name="PortalLine" type="StaticBody2D" parent="."]
collision_layer = 2
collision_mask = 2

[node name="CollisionShape2D" type="CollisionShape2D" parent="PortalLine"]
shape = SubResource( 5 )

[node name="ColorNode" type="Node2D" parent="."]
modulate = Color( 0.352941, 0.584314, 0.909804, 1 )
position = Vector2( -0.5, 0 )

[node name="Particles" parent="ColorNode" instance=ExtResource( 1 )]
position = Vector2( 17.5, 0 )
z_index = -1

[node name="ColorRect" type="ColorRect" parent="ColorNode"]
anchor_top = 0.5
anchor_bottom = 0.5
margin_top = -128.0
margin_bottom = 128.0
__meta__ = {
"_edit_use_anchors_": false
}

[node name="AnimationPlayer" type="AnimationPlayer" parent="."]
method_call_mode = 1
anims/BindPose = SubResource( 7 )
anims/close_portal = SubResource( 9 )
anims/closed_portal = SubResource( 10 )
anims/open_portal = SubResource( 8 )
